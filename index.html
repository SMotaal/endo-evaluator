<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <meta
      name="Description"
      content="The Endo async read-eval-print-loop (REPL)."
    />
    <base href="/" />

    <title>Endo Evaluator</title>
    <style>
      html,
      body {
        height: 100%;
      }

      * {
        padding: 0;
        margin: 0;
        box-sizing: border-box;
      }

      .container {
        display: flex;
        flex-direction: column;
        padding: 10px;
        height: 100%;
        overflow-y: auto;
      }

      .ui {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        align-items: stretch;
        height: 100%;
        justify-content: space-between;
      }

      main {
        flex-grow: 1;
      }

      .left {
        flex-grow: 1;
        flex-shrink: 0;
        padding: 10px;
      }

      .right {
        width: 600px;
        flex-grow: 1;
        flex-shrink: 1;
      }

      main:has(> endo-evaluator:not(:defined)) {
        /* outline: 1px solid red; */
        display: none;
      }
    </style>
    <title>Endo Evaluator</title>
  </head>

  <body>
    <noscript> You need to enable JavaScript to run this app.</noscript>

    <div class="container">
      <main class="left">
        <endo-evaluator id="o-repl">
          <span slot="hint">
            Use <code>O.help</code> for additional hints.
          </span>
        </endo-evaluator>
        <address>
          Source:
          <a
            target="_blank"
            href="https://github.com/endojs/endo-evaluator/"
            id="package_repo"
            ><span id="package_name">@endo/evaluator</span></a
          >
        </address>
      </main>
    </div>

    <script type="module">
      // Hardened JS.
      import '@endo/init/pre-remoting.js'; // Uncomment for Hardened JS.
      // import './src/noses.js'; // Uncomment for no Hardened JS.
      import { harden } from './src/maybe-lockdown.js';
      import './src/endo-evaluator.js';

      // eslint-disable-next-line import/order
      import { makeMarshal, decodeToJustin } from '@endo/marshal';

      const help = `\
O.noes! We don't have any better help than this right now.`;
      const O = Object.freeze(
        Object.assign(x => x, {
          help: Promise.resolve(help),
          noes: Promise.reject(Error('O NOES!!!')),
        }),
      );
      O.noes.catch(() => {});

      const { toCapData } = makeMarshal(undefined, undefined, {
        marshalName: 'Justin render',
      });
      const just = x => {
        harden(x);
        const { body, slots } = toCapData(x);
        const str = decodeToJustin(JSON.parse(body), true, slots);
        return str;
      };

      const repl = document.getElementById('o-repl');
      repl.endowments = { O };
      repl.just = just;
    </script>
  </body>
</html>
